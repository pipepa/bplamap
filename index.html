<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–û–±–≤–µ–¥–µ–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π –£–∫—Ä–∞—ó–Ω–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #121212; }
    #map { height: 100vh; width: 100vw; }

    .leaflet-popup-content button {
      margin: 5px 0;
      padding: 5px 10px;
      background: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .leaflet-popup-content button:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ë–ü–õ–ê -->
  <div id="contextMenu" style="position: absolute; display: none; background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 6px; z-index: 10000; font-family: sans-serif;">
    <button onclick="addDrone()" style="background: #333; border: none; padding: 5px 10px; color: white; cursor: pointer; border-radius: 4px;">‚ûï –î–æ–¥–∞—Ç–∏ –ë–ü–õ–ê</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([49.0, 31.0], 6);

    // –¢–µ–º–Ω–∞ –∫–∞—Ä—Ç–∞
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CartoDB',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    // –ó–±–µ—Ä—ñ–≥–∞—Ç–∏–º–µ –≤–∏–¥—ñ–ª–µ–Ω—ñ –æ–±–ª–∞—Å—Ç—ñ
    const selectedLayers = new Map();

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ –æ–±–ª–∞—Å—Ç—ñ –£–∫—Ä–∞—ó–Ω–∏ –∑ GeoJSON —Ñ–∞–π–ª—ñ–≤
    const regionFiles = [
      'geojson/UA_32_Kyivska.geojson',
      'geojson/UA_53_Poltavska.geojson',
      'geojson/UA_46_Lvivska.geojson',
      'geojson/UA_63_Kharkivska.geojson',
      'geojson/UA_12_Dnipropetrovska.geojson',
      'geojson/UA_51_Odeska.geojson',
      'geojson/UA_05_Vinnytska.geojson',
      'geojson/UA_71_Cherkaska.geojson',
      'geojson/UA_74_Chernihivska.geojson',
      'geojson/UA_77_Chernivetska.geojson',
      'geojson/UA_68_Khmelnytska.geojson',
      'geojson/UA_65_Khersonska.geojson',
      'geojson/UA_61_Ternopilska.geojson',
      'geojson/UA_59_Sumska.geojson',
      'geojson/UA_56_Rivnenska.geojson',
      'geojson/UA_48_Mykolaivska.geojson',
      'geojson/UA_35_Kirovohradska.geojson',
      'geojson/UA_26_Ivano_Frankivska.geojson',
      'geojson/UA_23_Zaporizka.geojson',
      'geojson/UA_21_Zakarpatska.geojson',
      'geojson/UA_18_Zhytomyrska.geojson',
      'geojson/UA_14_Donetska.geojson',
      'geojson/UA_09_Luhanska.geojson',
      'geojson/UA_07_Volynska.geojson'
    ];

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±–ª–∞—Å—Ç—ñ
    async function loadRegion(filePath) {
      try {
        const response = await fetch(filePath);
        const data = await response.json();
        
        const layer = L.geoJSON(data, {
          style: {
            color: "#666",
            weight: 1,
            fillOpacity: 0.1
          },
          onEachFeature: function (feature, layer) {
            const name = feature.properties?.name || "–û–±–ª–∞—Å—Ç—å";
            
            layer.on('click', function (e) {
              // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±–≤–æ–¥–∏–º–æ –æ–±–ª–∞—Å—Ç—å –ø—Ä–∏ –∫–ª—ñ–∫—É
              highlight(name);
              
              const popup = `
                <strong>${name}</strong><br/>
                <button onclick="highlight('${name}')">üî¥ –û–±–≤–µ—Å—Ç–∏</button><br/>
                <button onclick="unhighlight('${name}')">‚ö™ –ó–Ω—è—Ç–∏ –æ–±–≤–µ–¥–µ–Ω–Ω—è</button>
              `;
              layer.bindPopup(popup).openPopup();
            });

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —à–∞—Ä
            selectedLayers.set(name, layer);
          }
        }).addTo(map);
        
        return layer;
      } catch (error) {
        console.error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ${filePath}:`, error);
        return null;
      }
    }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ –æ–±–ª–∞—Å—Ç—ñ
    Promise.all(regionFiles.map(loadRegion)).then(() => {
      console.log('–í—Å—ñ –æ–±–ª–∞—Å—Ç—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
    });

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ë–ü–õ–ê
    let contextMenu = document.getElementById("contextMenu");
    let clickedLatLng = null;

    // –ü—Ä–∏ –ø—Ä–∞–≤–æ–º—É –∫–ª—ñ–∫—É –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–µ–Ω—é
    map.on('contextmenu', function (e) {
      clickedLatLng = e.latlng;

      contextMenu.style.left = e.originalEvent.pageX + "px";
      contextMenu.style.top = e.originalEvent.pageY + "px";
      contextMenu.style.display = "block";
    });

    // –ö–ª—ñ–∫ –¥–µ—Å—å —ñ–Ω–¥–µ ‚Äî —Ö–æ–≤–∞—î–º–æ –º–µ–Ω—é
    map.on('click', function () {
      contextMenu.style.display = "none";
    });

    // –î–æ–¥–∞—Ç–∏ –ë–ü–õ–ê
    window.addDrone = function () {
      if (!clickedLatLng) return;

      const droneIcon = L.icon({
        iconUrl: 'image.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      });

      L.marker(clickedLatLng, { icon: droneIcon })
        .addTo(map)
        .bindPopup("–ë–ü–õ–ê");

      contextMenu.style.display = "none";
    };

    // –ü—Ä–∏ scroll/zoom —Ç–∞–∫–æ–∂ —Ö–æ–≤–∞—î–º–æ –º–µ–Ω—é
    map.on("movestart zoomstart", () => {
      contextMenu.style.display = "none";
    });

    // –û–±–≤–µ—Å—Ç–∏ –æ–±–ª–∞—Å—Ç—å
    window.highlight = function (name) {
      const layer = selectedLayers.get(name);
      if (layer) {
        layer.setStyle({
          color: "red",
          weight: 3,
          fillColor: "red",
          fillOpacity: 0.3
        });
        layer.closePopup();
      }
    };

    // –ó–Ω—è—Ç–∏ –æ–±–≤–µ–¥–µ–Ω–Ω—è
    window.unhighlight = function (name) {
      const layer = selectedLayers.get(name);
      if (layer) {
        layer.setStyle({
          color: "#666",
          weight: 1,
          fillColor: "#000",
          fillOpacity: 0.1
        });
        layer.closePopup();
      }
    };

    // –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –æ–±–≤–µ–¥–µ–Ω–Ω—è
    window.clearAllHighlights = function () {
      selectedLayers.forEach((layer, name) => {
        layer.setStyle({
          color: "#666",
          weight: 1,
          fillColor: "#000",
          fillOpacity: 0.1
        });
      });
    };

    // –û–±–≤–µ—Å—Ç–∏ –≤—Å—ñ –æ–±–ª–∞—Å—Ç—ñ
    window.highlightAll = function () {
      selectedLayers.forEach((layer, name) => {
        layer.setStyle({
          color: "red",
          weight: 3,
          fillColor: "red",
          fillOpacity: 0.3
        });
      });
    };

    // –†–µ–∂–∏–º –º–∞–ª—é–≤–∞–Ω–Ω—è
    let drawingMode = false;
    let drawingLayer = null;

    window.toggleDrawingMode = function () {
      drawingMode = !drawingMode;
      const button = document.querySelector('button[onclick="toggleDrawingMode()"]');
      
      if (drawingMode) {
        button.style.background = '#f57c00';
        button.textContent = '‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ –º–∞–ª—é–≤–∞–Ω–Ω—è';
        startDrawing();
      } else {
        button.style.background = '#388e3c';
        button.textContent = '‚úèÔ∏è –ú–∞–ª—é–≤–∞—Ç–∏ –æ–±–ª–∞—Å—Ç—å';
        stopDrawing();
      }
    };

    function startDrawing() {
      if (!drawingLayer) {
        drawingLayer = L.layerGroup().addTo(map);
      }
      
      map.on('click', onMapClick);
    }

    function stopDrawing() {
      map.off('click', onMapClick);
    }

    function onMapClick(e) {
      if (!drawingMode) return;
      
      const marker = L.marker(e.latlng, {
        icon: L.divIcon({
          className: 'drawing-marker',
          html: '<div style="background: red; width: 8px; height: 8px; border-radius: 50%; border: 2px solid white;"></div>',
          iconSize: [12, 12]
        })
      }).addTo(drawingLayer);
      
      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç–æ—á–∫–∏ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–ª—ñ–≥–æ–Ω—É
      if (!window.drawingPoints) {
        window.drawingPoints = [];
      }
      window.drawingPoints.push(e.latlng);
      
      // –Ø–∫—â–æ —î –±—ñ–ª—å—à–µ 2 —Ç–æ—á–æ–∫, –º–∞–ª—é—î–º–æ –ø–æ–ª—ñ–≥–æ–Ω
      if (window.drawingPoints.length >= 3) {
        const polygon = L.polygon(window.drawingPoints, {
          color: 'red',
          weight: 3,
          fillColor: 'red',
          fillOpacity: 0.3
        }).addTo(drawingLayer);
      }
    }

    // –û—á–∏—Å—Ç–∏—Ç–∏ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω—ñ –æ–±–ª–∞—Å—Ç—ñ
    window.clearDrawnAreas = function () {
      if (drawingLayer) {
        drawingLayer.clearLayers();
      }
      window.drawingPoints = [];
    };

    // –®–≤–∏–¥–∫–∏–π –≤–∏–±—ñ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ
    window.highlightSpecific = function (regionName) {
      // –°–ø–æ—á–∞—Ç–∫—É –æ—á–∏—â–∞—î–º–æ –≤—Å—ñ –æ–±–≤–µ–¥–µ–Ω–Ω—è
      clearAllHighlights();
      
      // –ü–æ—Ç—ñ–º –æ–±–≤–æ–¥–∏–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –æ–±–ª–∞—Å—Ç—å
      const layer = selectedLayers.get(regionName);
      if (layer) {
        layer.setStyle({
          color: "red",
          weight: 3,
          fillColor: "red",
          fillOpacity: 0.3
        });
        
        // –¶–µ–Ω—Ç—Ä—É—î–º–æ –∫–∞—Ä—Ç—É –Ω–∞ –≤–∏–±—Ä–∞–Ω—ñ–π –æ–±–ª–∞—Å—Ç—ñ
        map.fitBounds(layer.getBounds());
      }
    };
  </script>
</body>
</html>
