<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ë–ü–õ–ê –¥–ª—è –ú–∏–∫–æ–ª–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #121212; }
    #map { height: 100vh; width: 100vw; }

    .leaflet-popup-content button {
      margin: 5px 0;
      padding: 5px 10px;
      background: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .leaflet-popup-content button:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- –ü–∞–Ω–µ–ª—å IP –∞–¥—Ä–µ—Å –∑–ª—ñ–≤–∞ -->
  <div id="ipPanel" style="position: absolute; top: 10px; left: 10px; background: #222; padding: 15px; border-radius: 8px; z-index: 1000; color: white; font-family: sans-serif; max-width: 300px; max-height: 400px; overflow-y: auto;">
    <h4 style="margin: 0 0 15px 0; color: #4CAF50;">üåê –í—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ</h4>
    <div id="ipList" style="font-size: 12px;">
      <div style="color: #888; font-style: italic;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
    <button onclick="refreshIPs()" style="background: #4CAF50; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-top: 10px; width: 100%;">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
  </div>
  
  <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ë–ü–õ–ê -->
  <div id="contextMenu" style="position: absolute; display: none; background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 6px; z-index: 10000; font-family: sans-serif;">
    <button onclick="addDrone()" style="background: #333; border: none; padding: 5px 10px; color: white; cursor: pointer; border-radius: 4px;">‚ûï –î–æ–¥–∞—Ç–∏ –ë–ü–õ–ê</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([49.0, 31.0], 6);

    // –¢–µ–º–Ω–∞ –∫–∞—Ä—Ç–∞
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CartoDB',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    // –ó–±–µ—Ä—ñ–≥–∞—Ç–∏–º–µ –≤–∏–¥—ñ–ª–µ–Ω—ñ –æ–±–ª–∞—Å—Ç—ñ
    const selectedLayers = new Map();

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ –æ–±–ª–∞—Å—Ç—ñ –£–∫—Ä–∞—ó–Ω–∏ –∑ GeoJSON —Ñ–∞–π–ª—ñ–≤
    const regionFiles = [
      'geojson/UA_32_Kyivska.geojson',
      'geojson/UA_53_Poltavska.geojson',
      'geojson/UA_46_Lvivska.geojson',
      'geojson/UA_63_Kharkivska.geojson',
      'geojson/UA_12_Dnipropetrovska.geojson',
      'geojson/UA_51_Odeska.geojson',
      'geojson/UA_05_Vinnytska.geojson',
      'geojson/UA_71_Cherkaska.geojson',
      'geojson/UA_74_Chernihivska.geojson',
      'geojson/UA_77_Chernivetska.geojson',
      'geojson/UA_68_Khmelnytska.geojson',
      'geojson/UA_65_Khersonska.geojson',
      'geojson/UA_61_Ternopilska.geojson',
      'geojson/UA_59_Sumska.geojson',
      'geojson/UA_56_Rivnenska.geojson',
      'geojson/UA_48_Mykolaivska.geojson',
      'geojson/UA_35_Kirovohradska.geojson',
      'geojson/UA_26_Ivano_Frankivska.geojson',
      'geojson/UA_23_Zaporizka.geojson',
      'geojson/UA_21_Zakarpatska.geojson',
      'geojson/UA_18_Zhytomyrska.geojson',
      'geojson/UA_14_Donetska.geojson',
      'geojson/UA_09_Luhanska.geojson',
      'geojson/UA_07_Volynska.geojson'
    ];

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±–ª–∞—Å—Ç—ñ
    async function loadRegion(filePath) {
      try {
        const response = await fetch(filePath);
        const data = await response.json();
        
        const layer = L.geoJSON(data, {
          style: {
            color: "#666",
            weight: 1,
            fillOpacity: 0.1
          },
          onEachFeature: function (feature, layer) {
            const name = feature.properties?.name || "–û–±–ª–∞—Å—Ç—å";
            
            layer.on('click', function (e) {
              // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±–≤–æ–¥–∏–º–æ –æ–±–ª–∞—Å—Ç—å –ø—Ä–∏ –∫–ª—ñ–∫—É
              highlight(name);
              
              const popup = `
                <strong>${name}</strong><br/>
                <button onclick="highlight('${name}')">üî¥ –û–±–≤–µ—Å—Ç–∏</button><br/>
                <button onclick="unhighlight('${name}')">‚ö™ –ó–Ω—è—Ç–∏ –æ–±–≤–µ–¥–µ–Ω–Ω—è</button>
              `;
              layer.bindPopup(popup).openPopup();
            });

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —à–∞—Ä
            selectedLayers.set(name, layer);
          }
        }).addTo(map);
        
        return layer;
      } catch (error) {
        console.error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ${filePath}:`, error);
        return null;
      }
    }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ –æ–±–ª–∞—Å—Ç—ñ
    Promise.all(regionFiles.map(loadRegion)).then(() => {
      console.log('–í—Å—ñ –æ–±–ª–∞—Å—Ç—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
    });

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ë–ü–õ–ê
    let contextMenu = document.getElementById("contextMenu");
    let clickedLatLng = null;

    // –ü—Ä–∏ –ø—Ä–∞–≤–æ–º—É –∫–ª—ñ–∫—É –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–µ–Ω—é
    map.on('contextmenu', function (e) {
      clickedLatLng = e.latlng;

      contextMenu.style.left = e.originalEvent.pageX + "px";
      contextMenu.style.top = e.originalEvent.pageY + "px";
      contextMenu.style.display = "block";
    });

    // –ö–ª—ñ–∫ –¥–µ—Å—å —ñ–Ω–¥–µ ‚Äî —Ö–æ–≤–∞—î–º–æ –º–µ–Ω—é
    map.on('click', function () {
      contextMenu.style.display = "none";
    });

    // –î–æ–¥–∞—Ç–∏ –ë–ü–õ–ê
    window.addDrone = function () {
      if (!clickedLatLng) return;

      const droneIcon = L.icon({
        iconUrl: 'image.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      });

      L.marker(clickedLatLng, { icon: droneIcon })
        .addTo(map)
        .bindPopup("–ë–ü–õ–ê");

      contextMenu.style.display = "none";
    };

    // –ü—Ä–∏ scroll/zoom —Ç–∞–∫–æ–∂ —Ö–æ–≤–∞—î–º–æ –º–µ–Ω—é
    map.on("movestart zoomstart", () => {
      contextMenu.style.display = "none";
    });

    // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ IP –∞–¥—Ä–µ—Å–∞–º–∏
    let visitors = [];

    // –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—É IP –∞–¥—Ä–µ—Å—É
    async function getCurrentIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è IP:', error);
        return '–ù–µ–≤—ñ–¥–æ–º–æ';
      }
    }

    // –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ IP
    async function getIPInfo(ip) {
      try {
        const response = await fetch(`https://ipapi.co/${ip}/json/`);
        const data = await response.json();
        return {
          country: data.country_name || '–ù–µ–≤—ñ–¥–æ–º–æ',
          city: data.city || '–ù–µ–≤—ñ–¥–æ–º–æ',
          region: data.region || '–ù–µ–≤—ñ–¥–æ–º–æ'
        };
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ IP:', error);
        return {
          country: '–ù–µ–≤—ñ–¥–æ–º–æ',
          city: '–ù–µ–≤—ñ–¥–æ–º–æ',
          region: '–ù–µ–≤—ñ–¥–æ–º–æ'
        };
      }
    }

    // –î–æ–¥–∞—Ç–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á–∞
    async function addVisitor() {
      const ip = await getCurrentIP();
      const info = await getIPInfo(ip);
      const timestamp = new Date().toLocaleString('uk-UA');
      
      const visitor = {
        ip: ip,
        country: info.country,
        city: info.city,
        region: info.region,
        timestamp: timestamp
      };

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤–∂–µ —î —Ç–∞–∫–∏–π IP
      const existingIndex = visitors.findIndex(v => v.ip === ip);
      if (existingIndex !== -1) {
        visitors[existingIndex] = visitor;
      } else {
        visitors.unshift(visitor); // –î–æ–¥–∞—î–º–æ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫
      }

      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ JSON —Ñ–∞–π–ª —á–µ—Ä–µ–∑ GitHub API
      await saveVisitorsToGitHub();
      
      updateIPList();
    }

    // –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤ —á–µ—Ä–µ–∑ GitHub API
    async function saveVisitorsToGitHub() {
      try {
        const data = {
          visitors: visitors,
          lastUpdated: new Date().toISOString()
        };
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ commit —á–µ—Ä–µ–∑ GitHub API
        const response = await fetch('https://api.github.com/repos/pipepa/bplamap/contents/visitors.json', {
          method: 'PUT',
          headers: {
            'Authorization': 'token ghp_1234567890abcdef', // –¢—É—Ç –ø–æ—Ç—Ä—ñ–±–µ–Ω –≤–∞—à GitHub token
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: '–û–Ω–æ–≤–ª–µ–Ω–æ —Å–ø–∏—Å–æ–∫ –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤',
            content: btoa(JSON.stringify(data, null, 2)), // –ö–æ–¥—É—î–º–æ –≤ base64
            sha: await getFileSHA()
          })
        });
        
        if (response.ok) {
          console.log('–í—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ GitHub');
        } else {
          console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ GitHub:', response.status);
        }
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É:', error);
      }
    }

    // –û—Ç—Ä–∏–º–∞—Ç–∏ SHA —Ñ–∞–π–ª—É –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    async function getFileSHA() {
      try {
        const response = await fetch('https://api.github.com/repos/pipepa/bplamap/contents/visitors.json');
        const data = await response.json();
        return data.sha;
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è SHA:', error);
        return null;
      }
    }

    // –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ IP
    function updateIPList() {
      const ipList = document.getElementById('ipList');
      
      if (visitors.length === 0) {
        ipList.innerHTML = '<div style="color: #888; font-style: italic;">–ù–µ–º–∞—î –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤</div>';
        return;
      }

      ipList.innerHTML = visitors.map(visitor => `
        <div style="border-bottom: 1px solid #444; padding: 8px 0; margin-bottom: 8px;">
          <div style="font-weight: bold; color: #4CAF50;">${visitor.ip}</div>
          <div style="color: #ccc; font-size: 11px;">
            ${visitor.city}, ${visitor.region}, ${visitor.country}
          </div>
          <div style="color: #888; font-size: 10px;">
            ${visitor.timestamp}
          </div>
        </div>
      `).join('');
    }

    // –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫
    window.refreshIPs = function() {
      addVisitor();
    };

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ
    async function loadVisitors() {
      try {
        const response = await fetch('visitors.json');
        const data = await response.json();
        visitors = data.visitors || [];
        updateIPList();
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤:', error);
        visitors = [];
        updateIPList();
      }
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    (async function() {
      await loadVisitors();
      await addVisitor(); // –î–æ–¥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á–∞
    })();

    // –û–±–≤–µ—Å—Ç–∏ –æ–±–ª–∞—Å—Ç—å
    window.highlight = function (name) {
      const layer = selectedLayers.get(name);
      if (layer) {
        layer.setStyle({
          color: "red",
          weight: 3,
          fillColor: "red",
          fillOpacity: 0.3
        });
        layer.closePopup();
      }
    };

    // –ó–Ω—è—Ç–∏ –æ–±–≤–µ–¥–µ–Ω–Ω—è
    window.unhighlight = function (name) {
      const layer = selectedLayers.get(name);
      if (layer) {
        layer.setStyle({
          color: "#666",
          weight: 1,
          fillColor: "#000",
          fillOpacity: 0.1
        });
        layer.closePopup();
      }
    };


  </script>
</body>
</html>
